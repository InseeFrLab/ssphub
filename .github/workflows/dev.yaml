on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed   # Including closed to remove preview when PR is closed. 
    branches:
      - main

env:
  PREVIEW_BRANCH: gh-pages

jobs:
  build-render:
    if: github.event.action != 'closed'  # If closing the PR, no publishing
    runs-on: ubuntu-latest
    # To cancel previous actions that could run on this PR
    concurrency:
      group: preview-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # To enable full access to Git repo
          ref: ${{ github.event.pull_request.head.ref }}  # Reference of the commit to checkout to. To ensure it's the one of the PR
          repository: ${{github.event.pull_request.head.repo.full_name}}  # Reference to the branch to checkout to. Useful with PR from forks
      
      # add software dependencies here and any libraries
      # See more at https://github.com/quarto-dev/quarto-actions/blob/main/examples/example-03-dependencies.md
      - name: Configure safe.directory  # Workaround for actions/checkout#760
        run: git config --global --add safe.directory /__w/ssphub/ssphub
      
      # Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13' # Version range or exact version of a Python version to use, using SemVer's version range syntax
      
      # Jupyter
      - run: pip install jupyter nbformat

      - name: Install npm
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        uses: actions/setup-node@v2          
        with:
          node-version: '18'

      # Quarto
      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Render Quarto  
      - name: Render Quarto Project
        uses: quarto-dev/quarto-actions/render@v2
        with:
          to: html
        # env: # For Quarto profiles
        #   QUARTO_PROFILE: preview
    
      - name: Deploy preview
        id: deploy-preview
        uses: rossjrw/pr-preview-action@v1.6.2
        with:
          source-dir: ./_site/
          preview-branch: ${{ env.PREVIEW_BRANCH }}
          action: deploy
          comment: false

      - name: Comment PR (custom)
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pr-preview
          message: |
            
            :---:
            | <p></p> :rocket: View preview at <br> ${{ steps.deploy-preview.outputs.preview-url }} <br><br>
            | <h6>Built to branch [`${{ env.PREVIEW_BRANCH }}`](${{ github.server_url }}/${{ github.repository }}/tree/${{ env.PREVIEW_BRANCH }}) at ${{ steps.deploy-preview.outputs.action-start-time }}. <br> Preview will be ready when the [GitHub Pages deployment](${{ github.server_url }}/${{ github.repository }}/deployments) is complete. <br><br> </h6>


  delete-preview:
    if: github.event.action == 'closed'  # Only run when PR is closed
    runs-on: ubuntu-latest
    steps:
      - name: Remove preview
        id: remove-preview
        uses: rossjrw/pr-preview-action@v1.6.2
        with:
          action: remove

      - name: Comment PR that preview was removed
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pr-preview
          message: |
            :---:
            Preview removed because the pull request was closed.
            ${{ steps.remove-preview.outputs.action-start-time }}
